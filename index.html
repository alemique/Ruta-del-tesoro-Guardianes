<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guía del Tiempo - Guardianes de San Juan</title>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --color-primary: #f39c12; /* Naranja/Dorado principal */
            --color-secondary: #e67e22; /* Naranja más oscuro */
            --color-background-dark: #121828; /* Azul noche muy oscuro */
            --color-background-medium: #161e31; /* Azul noche intermedio */
            --color-background-light: #1a243a; /* Azul noche más claro */

            --color-text-primary-on-dark: #e0e0e0;
            --color-text-secondary-on-dark: #bdc3c7;
            --color-text-on-primary: #121828; /* Texto oscuro sobre fondo primario */

            --font-primary: 'Teko', sans-serif;
            --font-secondary: 'Roboto', sans-serif;
        }

        body {
            font-family: var(--font-secondary);
            background-color: var(--color-background-dark);
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            color: var(--color-text-primary-on-dark);
            margin: 0;
            padding: 20px 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        #root {
            width: 100%;
            max-width: 500px;
            background-color: var(--color-background-medium);
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(243,156,18, 0.35);
            overflow: hidden;
            border: 3px solid var(--color-primary);
        }

        .app-container {
            text-align: center;
            transition: opacity 0.5s ease-in-out;
        }

        /* --- LOGIN PAGE --- */
        .login-container {
            padding: 30px 25px;
            background: linear-gradient(145deg, var(--color-background-medium), var(--color-background-dark));
            color: var(--color-text-primary-on-dark);
        }
        .login-container img.logo {
            width: 310px; 
            margin-bottom: 10px;
        }
        .login-container h1 {
            font-family: var(--font-primary);
            font-size: 2.5rem;
            margin: 0 0 8px 0;
            color: var(--color-primary);
            line-height: 1.1;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .login-container .lema {
            font-family: var(--font-secondary);
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: var(--color-text-secondary-on-dark);
        }
        .login-container input {
            font-family: var(--font-secondary);
            width: calc(100% - 24px);
            padding: 12px;
            margin-top: 5px;
            border: 2px solid var(--color-primary);
            border-radius: 5px;
            background: var(--color-background-light);
            color: var(--color-text-primary-on-dark);
            font-size: 1.1rem;
        }
        .login-container input::placeholder {
            color: var(--color-text-secondary-on-dark);
            opacity: 0.7;
        }
        .login-container button {
            font-family: var(--font-primary);
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            background-color: var(--color-primary);
            color: var(--color-text-on-primary);
            border: none;
            border-radius: 8px;
            font-size: 1.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .login-container button:hover {
            background-color: var(--color-secondary);
            color: white;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .login-container label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 0.95rem;
            color: var(--color-text-secondary-on-dark);
            text-align: left;
        }

        /* --- HEADER --- */
        .header {
            background-color: var(--color-background-dark);
            color: var(--color-text-primary-on-dark);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--color-primary);
        }
        .header-info span, .header-score .score, .header-score .timer {
            font-family: var(--font-primary);
            font-size: 1.5rem;
            display: block;
        }
        .header-info .team-name {
            font-size: 1.8rem;
            color: var(--color-primary);
            font-weight: 600;
        }
        .header-info .team-title {
            font-size: 0.9rem;
            color: var(--color-text-secondary-on-dark);
            letter-spacing: 0.5px;
        }
        .header-score { text-align: right; }
        .header-score .score { color: var(--color-primary); font-weight: 500; }
        .header-score .timer { color: var(--color-text-primary-on-dark); }

        /* --- DASHBOARD & CONTAINERS --- */
        .dashboard-content {
            padding: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .stage-container, .challenge-container, .end-container, .en-ruta-container {
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            padding: 20px;
            background: var(--color-background-light);
            color: var(--color-text-primary-on-dark);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: fadeIn 0.6s ease-in-out;
            margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h3 {
            font-family: var(--font-primary);
            font-size: 2rem;
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-secondary);
            padding-bottom: 10px;
            line-height: 1.2;
            font-weight: 600;
        }
        .stage-container h3, .challenge-container h3 {
            font-size: 1.8rem;
        }

        p { font-size: 1rem; line-height: 1.6; color: var(--color-text-secondary-on-dark); margin-bottom: 15px; }
        strong { color: var(--color-text-primary-on-dark); font-weight: 700; }

        input:not(.login-container input) {
            font-family: var(--font-secondary);
            width: calc(100% - 24px);
            padding: 12px;
            font-size: 1.05rem;
            border: 1px solid var(--color-text-secondary-on-dark);
            border-radius: 5px;
            margin-top: 10px;
            background-color: var(--color-background-medium);
            color: var(--color-text-primary-on-dark);
        }
        input:not(.login-container input)::placeholder { color: var(--color-text-secondary-on-dark); opacity: 0.6; }

        /* --- BOTONES --- */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        @media (min-width: 400px) {
            .button-group {
                flex-direction: row;
            }
        }

        .primary-button, .secondary-button {
            font-family: var(--font-primary);
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 1.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 2px solid transparent;
        }
        .primary-button:disabled, .secondary-button:disabled {
            background-color: #56595d;
            cursor: not-allowed;
            color: #909397;
            box-shadow: none;
            transform: none;
            border-color: #56595d;
        }

        .primary-button {
            background-color: var(--color-primary);
            color: var(--color-text-on-primary);
            border-color: var(--color-primary);
        }
        .primary-button:hover:not(:disabled) {
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
            color: white;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .secondary-button {
            background-color: transparent;
            color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .secondary-button:hover:not(:disabled) {
            background-color: var(--color-primary);
            color: var(--color-text-on-primary);
            transform: translateY(-2px);
        }

        .feedback { margin-top: 15px; font-size: 1.1rem; font-weight: bold; }
        .feedback.success { color: #27ae60; }
        .feedback.error { color: #e74c3c; }

        /* ... otros estilos ... */
        .en-ruta-container .primary-button { margin-top: 20px; }
        .challenge-container .primary-button { margin-top: 20px; }
        .transmission-box, .mecenas-box { background-color: rgba(243,156,18, 0.07); border-left: 4px solid var(--color-primary); padding: 12px 18px; margin: 20px 0; border-radius: 4px; }
        .transmission-box p, .mecenas-box p { margin: 5px 0; color: var(--color-text-secondary-on-dark); font-style: italic; }
        .transmission-box strong, .mecenas-box strong { color: var(--color-primary); font-style: normal; font-weight: 600; }
        .challenge-timer { font-family: var(--font-primary); font-size: 2.5rem; color: #e74c3c; margin: 10px 0 15px 0; animation: pulseTemporal 1.5s infinite; }
        @keyframes pulseTemporal { 0% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.03); } 100% { opacity: 0.7; transform: scale(1); } }
        .trivia-options { list-style: none; padding: 0; margin-top: 15px; }
        .trivia-options li { background: var(--color-background-medium); color: var(--color-text-primary-on-dark); margin: 10px 0; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; border: 2px solid var(--color-text-secondary-on-dark); font-size: 1rem; }
        .trivia-options li:hover { background: var(--color-background-light); transform: translateX(5px); border-color: var(--color-primary); }
        .trivia-options li.selected { background: var(--color-primary); color: var(--color-text-on-primary); border-color: var(--color-secondary); font-weight: bold; }
        .en-ruta-container, .end-container { text-align: center; }
        .en-ruta-container .portal-image { width: 100%; max-width: 220px; height: auto; border-radius: 8px; margin-bottom: 15px; opacity: 0.7; border: 2px solid var(--color-primary); }
        .end-container .medal-image { width: 100px; margin-bottom: 10px; }
        .dev-reset-button { position: fixed; bottom: 10px; right: 10px; background-color: #c0392b; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9rem; font-family: var(--font-secondary); cursor: pointer; z-index: 2000; border: none; opacity: 0.8; transition: opacity 0.3s ease; }
        .dev-reset-button:hover { opacity: 1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- DATOS COMPLETOS DEL EVENTO ---
        const eventData = [
            // --- SANTA LUCÍA ---
            {
                id: 1, type: 'anchor', department: "Santa Lucía", location: "Parroquia Santa Lucía - El Templo Ecléctico", missionName: "Ancla: Vestigios del Sismo",
                enabler: "Consigna: Busquen el año del catastrófico terremoto que destruyó el 'hermoso templo colonial'.\nPista: Este evento marcó un antes y un después en la arquitectura de toda la provincia.",
                enablerKeyword: "1944", transmission: "Guardián, hemos detectado una cicatriz profunda en la línea de tiempo de este lugar sagrado. Debes anclar el año del evento que lo cambió todo para estabilizarla.",
                nextMissionId: 2
            },
            {
                id: 2, type: 'trivia', department: "Santa Lucía", location: "Parroquia Santa Lucía", missionName: "Trivia: El Templo de 1900",
                challenge: { question: "¿En qué año fue inaugurado el templo de estilo ecléctico que reemplazó a la primera capilla?", options: ["1894", "1900", "1944", "1964"], correctAnswer: "1900" },
                nextMissionId: 3
            },
            {
                id: 3, type: 'anchor', department: "Santa Lucía", location: "Parroquia Santa Lucía - El Templo Moderno", missionName: "Ancla: La Fe Reconstruida",
                enabler: "Consigna: Encuentren el año de inauguración de la iglesia moderna y actual, que reemplazó a la destruida por el gran sismo.\nPista: Se inauguró durante las fiestas patronales de diciembre.",
                enablerKeyword: "1964", transmission: "La fe de un pueblo se manifiesta en su capacidad de renacer. Encuentra el año en que este templo moderno abrió sus puertas para sellar esta memoria.",
                nextMissionId: 4
            },
            {
                id: 4, type: 'trivia', department: "Santa Lucía", location: "Parroquia Santa Lucía", missionName: "Trivia: Fervor Popular",
                challenge: { question: "¿Qué importante evento religioso, que congrega a miles de fieles, se celebra cada diciembre en la parroquia?", options: ["La Fiesta del Sol", "El aniversario del departamento", "La Fiesta Patronal de Santa Lucía", "La peregrinación a la Difunta Correa"], correctAnswer: "La Fiesta Patronal de Santa Lucía" },
                nextMissionId: 5
            },
            {
                id: 5, type: 'anchor', department: "Santa Lucía", location: "Monumento La Luz del Mundo - Orígenes", missionName: "Ancla: El Primer Destello",
                enabler: "Consigna: Identifiquen el año en que los primeros pobladores se reunían en esta zona, fecha a la que rinde homenaje la farola monumentaria.\nPista: El lugar era conocido históricamente como 'La Legua'.",
                enablerKeyword: "1869", transmission: "Detecto una débil señal de luz proveniente del pasado. Viaja al año de origen, cuando esta esquina se convirtió en un punto de encuentro vital para los pioneros.",
                nextMissionId: 6
            },
            {
                id: 6, type: 'trivia', department: "Santa Lucía", location: "Monumento La Luz del Mundo", missionName: "Trivia: La Lámpara Primitiva",
                challenge: { question: "Según la tradición, ¿qué se utilizaba en el mangrullo para orientar a los viajeros antes de la lámpara de carburo?", options: ["Una fogata", "Una lámpara de aceite", "Antorchas", "Un farol eléctrico"], correctAnswer: "Una lámpara de aceite" },
                nextMissionId: 7
            },
            {
                id: 7, type: 'anchor', department: "Santa Lucía", location: "Monumento La Luz del Mundo - La 'Bichadora'", missionName: "Ancla: El Ojo del Pasado",
                enabler: "Consigna: ¿Qué tipo de institución de seguridad, que contaba con una torre de vigilancia llamada 'bichadora', funcionó en esta esquina 'décadas atrás'?\nPista: Su función era velar por la seguridad de los viajeros.",
                enablerKeyword: "Un puesto policial", transmission: "La seguridad de los viajeros era crucial. En esta esquina existió una institución protectora. Ancla su nombre para recordar su importante labor.",
                nextMissionId: 8
            },
            {
                id: 8, type: 'trivia', department: "Santa Lucía", location: "Monumento La Luz del Mundo", missionName: "Trivia: El Fin del Mundo Iluminado",
                challenge: { question: "¿Qué apodo le daban los antiguos pobladores al lugar donde se encendía la luz, marcando el límite de la ciudad iluminada?", options: ["El faro de La Legua", "El portal de la ciudad", "Donde terminaba el mundo", "La esquina del viajero"], correctAnswer: "Donde terminaba el mundo" },
                nextMissionId: 9
            },
            {
                id: 9, type: 'anchor', department: "Santa Lucía", location: "Puente de Hierro - Hito de Ingeniería", missionName: "Ancla: El Nacimiento del Gigante de Hierro",
                enabler: "Consigna: Encuentren el año de inauguración del puente, el más antiguo de su tipo en la provincia.\nPista: Su construcción fue una hazaña de la ingeniería para cruzar el caudaloso río.",
                enablerKeyword: "1893", transmission: "Este gigante de metal fue una revolución para su época. Anclar su año de nacimiento es vital para preservar la memoria del progreso.",
                nextMissionId: 10
            },
            {
                id: 10, type: 'trivia', department: "Santa Lucía", location: "Puente de Hierro", missionName: "Trivia: El Propósito Original",
                challenge: { question: "¿Para qué medio de transporte fue construido originalmente este puente metálico?", options: ["Peatones y carretas", "Tráfico carretero", "Ferrocarril", "Animales de carga"], correctAnswer: "Ferrocarril" },
                nextMissionId: 11
            },
            // ... (AQUÍ IRÍAN TODAS LAS DEMÁS MISIONES, SIGUIENDO LA MISMA ESTRUCTURA)
            {
                id: 33, // Este ID debe ser el último antes del final
                type: 'final',
                department: "Rivadavia Ancestral",
                location: "Parque de Rivadavia (Punto de Llegada)",
                missionName: "Misión: Sellar la Brecha Temporal",
                enabler: "¡Guardián, has llegado al nexo! El 'Ancla Temporal Final' para estabilizar la línea del tiempo de San Juan te será revelada por el Guardián Mayor al completar tu informe en la 'Guía del Tiempo'. Ingresa la palabra 'LEGADO' para confirmar la restauración.",
                enablerKeyword: "LEGADO",
                transmission: "Mensaje Urgente del Guardián Mayor: '¡Lo lograron! La Amenaza del Olvido retrocede gracias a su valor. Ingresen el Ancla Final. ¡El legado de San Juan está a salvo!'",
                nextMissionId: null
            }
        ];

        // --- CÓDIGOS DE ESCUADRÓN VÁLIDOS ---
        const validSquadCodes = {
            "GUARDIAN01": "Los CronoExploradores",
            "TIEMPOXYZ": "Vigías del Pasado",
            "SANJUAN2025": "Escuadrón Reliquia",
            "ASVTEST": "Equipo ASV Beta"
        };

        // --- COMPONENTES DE REACT ---
        const Header = ({ teamName, score, timer }) => {
            const formatTime = (totalSeconds) => {
                const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            };
            return (
                <div className="header">
                    <div className="header-info">
                        <span className="team-name">{teamName || "Escuadrón Desconocido"}</span>
                        <span className="team-title">GUARDIANES DEL TIEMPO</span>
                    </div>
                    <div className="header-score">
                        <span className="score">{score} FRAGMENTOS</span>
                        <span className="timer">⏳ {formatTime(timer)}</span>
                    </div>
                </div>
            );
        };

        const LoginPage = ({ onLogin, setErrorMessage, errorMessage }) => {
            const [squadCode, setSquadCode] = React.useState('');
            const logoUrl = "imagenes/LOGO 3 (1).png";
            const handleLoginInternal = () => {
                const normalizedCode = squadCode.toUpperCase().trim();
                if (validSquadCodes[normalizedCode]) {
                    onLogin(normalizedCode, validSquadCodes[normalizedCode]);
                    if (typeof setErrorMessage === 'function') setErrorMessage('');
                } else {
                    if (typeof setErrorMessage === 'function') setErrorMessage('⚠️ Código de Escuadrón no válido. ¡El tiempo se agota!');
                }
            };
            return (
                <div className="login-container">
                    <img src={logoUrl} alt="Logo Guardianes del Tiempo" className="logo" onError={(e) => { e.target.onerror = null; e.target.src="https://i.imgur.com/ZKiX1mO.png"; }} />
                    <h1>RUTA DEL TESORO:<br/>GUARDIANES DEL TIEMPO</h1>
                    <p className="lema">"¡El legado de San Juan te necesita! ¿Aceptas la misión?"</p>
                    <label htmlFor="squadCode">Código de Escuadrón:</label>
                    <input id="squadCode" type="text" placeholder="Ingresa tu código secreto" value={squadCode} onChange={(e) => setSquadCode(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleLoginInternal()} />
                    <button className="primary-button" onClick={handleLoginInternal}>ACTIVAR GUÍA DEL TIEMPO</button>
                    {errorMessage && <p className="feedback error" style={{ marginTop: '15px' }}>{errorMessage}</p>}
                </div>
            );
        };
        
        const EnRutaPage = ({ nextLocation, onArrival, department }) => {
             return(
                 <div className="en-ruta-container">
                     <img src="imagenes/VIAJANDO.png" alt="Portal Temporal Estilizado" className="portal-image" onError={(e) => { e.target.onerror = null; e.target.src='https://images.unsplash.com/photo-1520034475321-cbe63696469a?q=80&w=800&auto=format&fit=crop'; }} />
                     <h3>VIAJANDO A TRAVÉS DEL TIEMPO...</h3>
                     <p>Próxima Sincronización: <strong>{nextLocation}</strong></p>
                     <p>Departamento: <strong>{department}</strong></p>
                     <p>¡Mantén el rumbo, Guardián! Evita las 'distorsiones temporales' (¡y las multas de tránsito!).</p>
                     <button className="primary-button" onClick={onArrival}>LLEGADA CONFIRMADA</button>
                 </div>
             );
         };

        const EndGamePage = ({ score, finalTime, teamName }) => {
           return (
               <div className="end-container">
                   <img src="https://cdn-icons-png.flaticon.com/512/784/784408.png" alt="Medalla o Trofeo Guardián" className="medal-image"/>
                   <h3>¡MISIÓN TEMPORAL COMPLETADA, {teamName}!</h3>
                   <p>Has estabilizado la línea del tiempo de San Juan. ¡La 'Amenaza del Olvido' ha sido contenida gracias a tu escuadrón!</p>
                   <p><strong>Fragmentos de Historia Restaurados: {score}</strong></p>
                   <p><strong>Tiempo Total de la Misión: {finalTime}</strong></p>
                   <p>¡Has ganado tu Medalla "Guardián del Tiempo"! 🏅 Los "Custodios Mayores" y otros reconocimientos serán anunciados en el Concilio de Guardianes.</p>
                   <p style={{fontSize: "0.9rem", marginTop: "20px"}}><em>No olvides compartir tu hazaña y prepararte para la celebración.</em></p>
               </div>
           );
        };

        const ChallengeSection = ({ stage, onComplete }) => {
            const { challenge } = stage;
            const [selectedOption, setSelectedOption] = React.useState('');
            const [feedback, setFeedback] = React.useState({ message: '', type: ''});
            const [triviaTimer, setTriviaTimer] = React.useState(0);

            React.useEffect(() => {
                setFeedback({ message: '', type: ''});
                setSelectedOption('');
                setTriviaTimer(0);
                const interval = setInterval(() => setTriviaTimer(prev => prev + 1), 1000);
                return () => clearInterval(interval);
            }, [stage]);

            const calculatePoints = (timeInSeconds) => {
                if (timeInSeconds <= 30) return 50;
                if (timeInSeconds <= 60) return 35;
                if (timeInSeconds <= 90) return 20;
                return 10;
            };

            const handleSubmit = () => {
                const finalTime = triviaTimer;
                const isCorrect = selectedOption.toUpperCase() === challenge.correctAnswer.toUpperCase();
                const pointsWon = isCorrect ? calculatePoints(finalTime) : 0;

                setFeedback({
                    message: isCorrect ? `✔️ ¡Respuesta Correcta! Has recuperado ${pointsWon} Fragmentos en ${finalTime}s.` : `❌ Respuesta Incorrecta. No se han recuperado Fragmentos, ¡pero la misión continúa!`,
                    type: isCorrect ? 'success' : 'error'
                });
                
                setTimeout(() => {
                    onComplete(pointsWon);
                }, 2500);
            };

            return (
                <div className="challenge-container">
                    <h3>{`DESAFÍO: ${stage.missionName}`}</h3>
                    <div className="challenge-timer">⏱️ {triviaTimer}s</div>
                    <p>{challenge.question}</p>
                    <ul className="trivia-options">
                        {challenge.options.map(option => (
                            <li key={option} className={selectedOption === option ? 'selected' : ''} onClick={() => !feedback.message && setSelectedOption(option)}>
                                {option}
                            </li>
                        ))}
                    </ul>
                    <button className="primary-button" onClick={handleSubmit} disabled={!selectedOption || feedback.message}>VERIFICAR TRANSMISIÓN</button>
                    {feedback.message && <p className={`feedback ${feedback.type}`}>{feedback.message}</p>}
                </div>
            );
        };

        const AnchorStage = ({ stage, onComplete }) => {
            const [keyword, setKeyword] = React.useState('');
            const [error, setError] = React.useState('');
            const [anchorTimer, setAnchorTimer] = React.useState(0);
            const [isLocked, setIsLocked] = React.useState(false);

            React.useEffect(() => {
                const interval = setInterval(() => {
                    if (!isLocked) setAnchorTimer(prev => prev + 1);
                }, 1000);
                return () => clearInterval(interval);
            }, [isLocked]);

            const calculateAnchorPoints = (timeInSeconds) => {
                if (timeInSeconds <= 60) return 100;
                if (timeInSeconds <= 120) return 80;
                if (timeInSeconds <= 180) return 60;
                if (timeInSeconds <= 240) return 40;
                if (timeInSeconds <= 300) return 20;
                return 0;
            };

            const handleUnlockInternal = () => {
                if (keyword.toUpperCase().trim() === stage.enablerKeyword.toUpperCase().trim()) {
                    setIsLocked(true);
                    const points = calculateAnchorPoints(anchorTimer);
                    setError('');
                    setFeedback({ message: `✔️ ¡Ancla estabilizada! Has recuperado ${points} Fragmentos.`, type: 'success' });
                    setTimeout(() => onComplete(points), 2500);
                } else {
                    setError('🚫 Ancla Temporal incorrecta. ¡La distorsión persiste!');
                }
            };
            
            const handleSkip = () => {
                setIsLocked(true);
                setError('');
                setFeedback({ message: `Misión de anclaje omitida. No se han recuperado Fragmentos.`, type: 'error' });
                setTimeout(() => onComplete(0), 2500);
            };

            const [feedback, setFeedback] = React.useState({ message: '', type: ''});

            return (
                <div className="stage-container">
                    <h3>{`ANCLA: ${stage.missionName}`}</h3>
                    <div className="challenge-timer">⏱️ {anchorTimer}s</div>
                    <p><strong>Departamento:</strong> {stage.department}</p>
                    {stage.transmission && <div className="transmission-box"><p><strong>📡 Transmisión Interceptada:</strong> {stage.transmission}</p></div>}
                    <p><strong>Objetivo de la Coordenada:</strong> {stage.enabler}</p>
                    <input type="text" placeholder="Ingresa el 'Ancla Temporal'" value={keyword} onChange={(e) => setKeyword(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleUnlockInternal()}/>
                    <div className="button-group">
                        <button className="secondary-button" onClick={handleSkip} disabled={isLocked}>No sé</button>
                        <button className="primary-button" onClick={handleUnlockInternal} disabled={isLocked}>🗝️ ANCLAR RECUERDO</button>
                    </div>
                    {error && <p className="feedback error">{error}</p>}
                    {feedback.message && <p className={`feedback ${feedback.type}`}>{feedback.message}</p>}
                </div>
            );
        };
        
        const FinalStage = ({stage, onComplete}) => {
             const [keyword, setKeyword] = React.useState('');
             const [error, setError] = React.useState('');
             
             const handleUnlockInternal = () => {
                if (keyword.toUpperCase().trim() === stage.enablerKeyword.toUpperCase().trim()) {
                    onComplete(200); // Bonus por finalizar
                } else {
                    setError('🚫 Código final incorrecto.');
                }
            };
            
            return (
                 <div className="stage-container">
                    <h3>{stage.missionName}</h3>
                    {stage.transmission && <div className="transmission-box"><p><strong>📡 Transmisión Prioritaria:</strong> {stage.transmission}</p></div>}
                    <p><strong>Misión de Sellado:</strong> {stage.enabler}</p>
                    <input type="text" placeholder="Ingresa el Ancla Temporal Final" value={keyword} onChange={(e) => setKeyword(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleUnlockInternal()}/>
                    <div className="button-group">
                         <button className="primary-button" onClick={handleUnlockInternal}>✨ SELLAR BRECHA TEMPORAL ✨</button>
                    </div>
                    {error && <p className="feedback error">{error}</p>}
                </div>
            );
        }

        const App = () => {
            const [appState, setAppState] = React.useState(() => {
                const savedState = localStorage.getItem('guardianesAppState');
                try {
                    const parsedState = savedState ? JSON.parse(savedState) : null;
                    if (parsedState && typeof parsedState.status === 'string' && parsedState.status !== 'login') {
                        return parsedState;
                    }
                } catch (e) {
                    console.error("Error al parsear localStorage, usando estado inicial.", e);
                    localStorage.removeItem('guardianesAppState');
                }
                return {
                    status: 'login',
                    squadCode: null,
                    teamName: '',
                    currentMissionId: eventData.length > 0 ? eventData[0].id : 1,
                    score: 0,
                    mainTimer: 0,
                    finalTimeDisplay: '',
                    errorMessage: ''
                };
            });

            React.useEffect(() => {
                localStorage.setItem('guardianesAppState', JSON.stringify(appState));
            }, [appState]);

            React.useEffect(() => {
                let interval;
                if (appState.status !== 'login' && appState.status !== 'finished') {
                    interval = setInterval(() => {
                        setAppState(prev => ({ ...prev, mainTimer: prev.mainTimer + 1 }));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [appState.status]);

            const currentStageData = eventData.find(m => m.id === appState.currentMissionId);

            const handleLogin = (code, name) => {
                setAppState({
                    status: 'in_game',
                    squadCode: code,
                    teamName: name,
                    currentMissionId: eventData.length > 0 ? eventData[0].id : 1,
                    score: 0,
                    mainTimer: 0,
                    finalTimeDisplay: '',
                    errorMessage: ''
                });
            };
            
            const handleMissionComplete = (pointsEarned) => {
                if (!currentStageData) return;
                const newScore = appState.score + pointsEarned;

                if (typeof currentStageData.nextMissionId === 'number') {
                    setAppState(prev => ({ ...prev, score: newScore, status: 'on_the_road' }));
                } else {
                     const totalSeconds = appState.mainTimer;
                    const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                    const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                    const seconds = String(totalSeconds % 60).padStart(2, '0');
                    setAppState(prev => ({ ...prev, score: newScore, status: 'finished', finalTimeDisplay: `${hours}:${minutes}:${seconds}` }));
                }
            };
            
            const handleArrival = () => {
                if (!currentStageData) return;
                if (typeof currentStageData.nextMissionId === 'number') {
                    const nextMission = eventData.find(m => m.id === currentStageData.nextMissionId);
                    if (nextMission) {
                         setAppState(prev => ({ ...prev, currentMissionId: nextMission.id, status: 'in_game' }));
                    } else {
                        console.error(`Error: No se encontró la misión con ID ${currentStageData.nextMissionId}. Finalizando.`);
                        setAppState(prev => ({ ...prev, status: 'finished' }));
                    }
                } else {
                    setAppState(prev => ({ ...prev, status: 'finished' }));
                }
            };

            const handleResetDevelopment = () => {
                if (window.confirm("¿Seguro que quieres reiniciar toda la misión y borrar los datos guardados? (Solo para desarrollo)")) {
                    localStorage.removeItem('guardianesAppState');
                    window.location.reload();
                }
            };

            const renderContent = () => {
                if (appState.status === 'in_game' && (!eventData || eventData.length === 0)) {
                    return <p style={{padding: "20px"}}>Esperando carga de misiones del Guardián Mayor...</p>;
                }
                
                if (!currentStageData && (appState.status !== 'login' && appState.status !== 'finished')) {
                    return <p style={{padding: "20px"}}>Detectando anomalía temporal... (Error: Misión no encontrada o datos corruptos).</p>;
                }
                
                switch(appState.status) {
                    case 'login':
                        return <LoginPage onLogin={handleLogin} setErrorMessage={(msg) => setAppState(prev => ({ ...prev, errorMessage: msg }))} errorMessage={appState.errorMessage} />;
                    case 'in_game':
                        if (currentStageData.type === 'anchor') {
                             return <AnchorStage stage={currentStageData} onComplete={handleMissionComplete} />;
                        }
                        if (currentStageData.type === 'trivia') {
                             return <ChallengeSection stage={currentStageData} onComplete={handleMissionComplete} />;
                        }
                         if (currentStageData.type === 'final') {
                             return <FinalStage stage={currentStageData} onComplete={handleMissionComplete} />;
                        }
                        return <p>Error de misión</p>;
                    case 'on_the_road':
                        const nextMission = currentStageData ? eventData.find(m => m.id === currentStageData.nextMissionId) : null;
                        const nextLocationDisplay = nextMission ? (nextMission.location || "Nuevo Sector Temporal") : "Destino Final";
                        const nextDepartmentDisplay = nextMission ? nextMission.department : "Dimensión Desconocida";
                        return <EnRutaPage nextLocation={nextLocationDisplay} department={nextDepartmentDisplay} onArrival={handleArrival} />;
                    case 'finished':
                        return <EndGamePage score={appState.score} finalTime={appState.finalTimeDisplay} teamName={appState.teamName} />;
                    default:
                        console.error("Estado de la aplicación desconocido:", appState.status);
                        return <LoginPage onLogin={handleLogin} setErrorMessage={(msg) => setAppState(prev => ({ ...prev, errorMessage: msg }))} errorMessage={"Error en la Guía del Tiempo. Intenta ingresar tu código nuevamente."} />;
                }
            };

            return (
                <div className="app-container">
                    {appState.status !== 'login' && <Header teamName={appState.teamName} score={appState.score} timer={appState.mainTimer} />}
                    <div className="dashboard-content">
                        {renderContent()}
                    </div>
                    {appState.status !== 'login' && <button className="dev-reset-button" onClick={handleResetDevelopment}>RESET (DEV)</button>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
